<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>osu! Bounty Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <style>
        :root {
            --osu-pink: #FF66AB;
            --osu-pink-dark: #E85AA0;
            --osu-blue: #4A90E2;
            --osu-gray: #2C2C2C;
            --osu-gray-light: #3C3C3C;
            --osu-white: #FFFFFF;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .osu-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid var(--osu-pink);
            transition: all 0.3s ease;
        }
        
        .osu-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 102, 171, 0.3);
            border-color: var(--osu-pink-dark);
        }
        
        .osu-button {
            background: var(--osu-pink);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .osu-button:hover {
            background: var(--osu-pink-dark);
            transform: scale(1.05);
        }
        
        .star-rating {
            color: #FFD700;
        }
        
        .bounty-amount {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 102, 171, 0.3);
            border-top: 3px solid var(--osu-pink);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .filter-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .auth-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            border: 2px solid var(--osu-pink);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .auth-tab.active {
            border-bottom-color: var(--osu-pink);
            color: var(--osu-pink);
            font-weight: bold;
        }
        
        .user-info {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-4">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold text-white mb-2" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                osu! Bounty Portal
            </h1>
            <p class="text-xl text-white/90">Complete bounties and earn rewards!</p>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto">
            <!-- User Info Section -->
            <div id="userInfo" class="user-info hidden">
                <div class="flex items-center">
                    <i data-lucide="user" class="w-5 h-5 mr-2 text-pink-600"></i>
                    <span class="font-semibold">Welcome, <span id="username"></span>!</span>
                </div>
                <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">
                    <i data-lucide="log-out" class="inline w-4 h-4 mr-1"></i>
                    Logout
                </button>
            </div>

            <!-- Login/Register Button (shown when not logged in) -->
            <div id="loginPrompt" class="text-center mb-8">
                <button onclick="showAuthModal()" class="osu-button">
                    <i data-lucide="log-in" class="inline w-4 h-4 mr-1"></i>
                    Login
                </button>
            </div>
            <!-- Filter Section -->
            <section class="filter-section">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                        <input type="text" id="searchInput" placeholder="Search bounties..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Min Star Rating</label>
                        <input type="number" id="minStars" placeholder="0.0" step="0.1" min="0" max="10"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Max Star Rating</label>
                        <input type="number" id="maxStars" placeholder="10.0" step="0.1" min="0" max="10"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                        <select id="sortBy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500">
                            <option value="bounty-desc">Highest Bounty</option>
                            <option value="bounty-asc">Lowest Bounty</option>
                            <option value="stars-desc">Highest Stars</option>
                            <option value="stars-asc">Lowest Stars</option>
                            <option value="title">Title A-Z</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex gap-2">
                    <button onclick="applyFilters()" class="osu-button">
                        <i data-lucide="filter" class="inline w-4 h-4 mr-1"></i>
                        Apply Filters
                    </button>
                    <button onclick="resetFilters()" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition">
                        <i data-lucide="refresh-cw" class="inline w-4 h-4 mr-1"></i>
                        Reset
                    </button>
                </div>
            </section>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-white text-lg">Loading bounties...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden text-center py-12">
                <div class="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                <p class="text-white text-lg mb-2">Failed to load bounties</p>
                <p class="text-white/80" id="errorMessage">Please check your connection and try again.</p>
                <button onclick="loadBounties()" class="osu-button mt-4">
                    <i data-lucide="refresh-cw" class="inline w-4 h-4 mr-1"></i>
                    Retry
                </button>
            </div>

            <!-- Bounties Grid -->
            <div id="bountiesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- Bounty cards will be inserted here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12">
                <div class="text-white text-6xl mb-4">üéØ</div>
                <p class="text-white text-lg">No bounties found matching your criteria</p>
            </div>
        </main>

        <!-- Authentication Modal -->
        <div id="authModal" class="auth-modal hidden">
            <div class="auth-content">
                <h2 class="text-2xl font-bold text-center mb-6" style="color: var(--osu-pink);">Account Access</h2>
                
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="switchTab('login')">Login</div>
                </div>
                
                <!-- Login Form -->
                <div id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter username" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter password" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <button onclick="login()" class="osu-button w-full">
                        <i data-lucide="log-in" class="inline w-4 h-4 mr-1"></i>
                        Login
                    </button>
                </div>
                
                
                <div class="mt-4 text-center">
                    <button onclick="hideAuthModal()" class="text-gray-500 hover:text-gray-700">
                        Cancel
                    </button>
                </div>
                
                <div id="authError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden"></div>
                <div id="authSuccess" class="mt-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded hidden"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-16 pb-8">
            <p class="text-white/80">
                Made with ‚ù§Ô∏è for the osu! community | 
                <a href="https://docs.google.com/spreadsheets/d/1V_jS-HMJREMt7jZACD9aNZ08pWYlUkWNXm2HlpXvytE/edit?gid=0#gid=0" 
                   target="_blank" class="text-pink-300 hover:text-pink-200 underline">
                    View Data Source
                </a>
            </p>
        </footer>
    </div>

    <script>
        // Global variables
        let allBounties = [];
        let filteredBounties = [];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            initAuth();
            loadBounties();
            
            // Add enter key support for search
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') applyFilters();
            });
        });

        // Load bounties from Google Sheets
        async function loadBounties() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const bountiesGrid = document.getElementById('bountiesGrid');
            
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            bountiesGrid.classList.add('hidden');

            try {
                // Using Google Sheets API via public CSV export
                const spreadsheetId = '1V_jS-HMJREMt7jZACD9aNZ08pWYlUkWNXm2HlpXvytE';
                const gid = '0';
                const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch spreadsheet data');
                
                const csvData = await response.text();
                allBounties = parseCSV(csvData);
                
                loadingState.classList.add('hidden');
                displayBounties(allBounties);
                
            } catch (error) {
                console.error('Error loading bounties:', error);
                document.getElementById('errorMessage').textContent = error.message;
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
            }
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const bounties = [];
            
            // Skip header row if it exists
            const startIndex = lines[0].toLowerCase().includes('title') ? 1 : 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 8) {
                    bounties.push({
                        title: values[0] || 'Untitled Bounty',
                        map: values[1] || 'Unknown Map',
                        beatmapId: values[2] || '',
                        mapper: values[3] || 'Unknown',
                        difficulty: values[4] || 'Unknown',
                        starRating: parseFloat(values[5]) || 0,
                        bounty: parseFloat(values[6]) || 0,
                        description: values[7] || 'No description available'
                    });
                }
            }
            
            return bounties;
        }

        // Parse a single CSV line handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Display bounties
        function displayBounties(bounties) {
            const bountiesGrid = document.getElementById('bountiesGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (bounties.length === 0) {
                bountiesGrid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            bountiesGrid.classList.remove('hidden');
            
            bountiesGrid.innerHTML = bounties.map(bounty => createBountyCard(bounty)).join('');
            
            // Reinitialize Lucide icons for new content
            lucide.createIcons();
        }

        // Create bounty card HTML
        function createBountyCard(bounty) {
            const beatmapUrl = bounty.beatmapId ? `https://osu.ppy.sh/b/${bounty.beatmapId}` : '#';
            
            return `
                <div class="osu-card rounded-lg p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-gray-800 flex-1 mr-2">${escapeHtml(bounty.title)}</h3>
                        <div class="text-2xl font-bold bounty-amount">$${bounty.bounty.toFixed(2)}</div>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-gray-600">
                            <i data-lucide="music" class="w-4 h-4 mr-2"></i>
                            <a href="${beatmapUrl}" target="_blank" class="hover:text-pink-600 underline">
                                ${escapeHtml(bounty.map)}
                            </a>
                        </div>
                        
                        <div class="flex items-center text-gray-600">
                            <i data-lucide="user" class="w-4 h-4 mr-2"></i>
                            <span>Mapper: ${escapeHtml(bounty.mapper)}</span>
                        </div>
                        
                        <div class="flex items-center text-gray-600">
                            <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i>
                            <span>Difficulty: ${escapeHtml(bounty.difficulty)}</span>
                        </div>
                        
                        <div class="flex items-center star-rating">
                            <i data-lucide="star" class="w-4 h-4 mr-1"></i>
                            <span class="font-semibold">${bounty.starRating.toFixed(2)}‚≠ê</span>
                        </div>
                    </div>
                    
                    <div class="border-t pt-3">
                        <p class="text-gray-700 text-sm mb-3">${escapeHtml(bounty.description)}</p>
                        <button onclick="acceptBounty('${escapeHtml(bounty.title)}', '${escapeHtml(bounty.map)}', '${escapeHtml(bounty.beatmapId)}')" class="osu-button w-full">
                            <i data-lucide="target" class="inline w-4 h-4 mr-1"></i>
                            Accept Bounty
                        </button>
                    </div>
                </div>
            `;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const minStars = parseFloat(document.getElementById('minStars').value) || 0;
            const maxStars = parseFloat(document.getElementById('maxStars').value) || 10;
            const sortBy = document.getElementById('sortBy').value;
            
            filteredBounties = allBounties.filter(bounty => {
                const matchesSearch = !searchTerm || 
                    bounty.title.toLowerCase().includes(searchTerm) ||
                    bounty.map.toLowerCase().includes(searchTerm) ||
                    bounty.mapper.toLowerCase().includes(searchTerm) ||
                    bounty.description.toLowerCase().includes(searchTerm);
                
                const matchesStars = bounty.starRating >= minStars && bounty.starRating <= maxStars;
                
                return matchesSearch && matchesStars;
            });
            
            // Sort the filtered results
            filteredBounties.sort((a, b) => {
                switch(sortBy) {
                    case 'bounty-desc': return b.bounty - a.bounty;
                    case 'bounty-asc': return a.bounty - b.bounty;
                    case 'stars-desc': return b.starRating - a.starRating;
                    case 'stars-asc': return a.starRating - b.starRating;
                    case 'title': return a.title.localeCompare(b.title);
                    default: return 0;
                }
            });
            
            displayBounties(filteredBounties);
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('minStars').value = '';
            document.getElementById('maxStars').value = '';
            document.getElementById('sortBy').value = 'bounty-desc';
            displayBounties(allBounties);
        }

        // Authentication Functions
        let currentUser = null;
        const accountsSpreadsheetId = '1V_jS-HMJREMt7jZACD9aNZ08pWYlUkWNXm2HlpXvytE';
        const accountsGid = '373522173'; // Account sheet gid

        // Initialize auth state
        function initAuth() {
            const savedUser = localStorage.getItem('osuBountyUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showUserInfo();
            }
        }

        // Show/hide auth modal
        function showAuthModal() {
            document.getElementById('authModal').classList.remove('hidden');
            clearAuthMessages();
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.add('hidden');
            clearAuthForms();
            clearAuthMessages();
        }


        // Clear auth messages
        function clearAuthMessages() {
            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authSuccess').classList.add('hidden');
        }

        // Clear auth forms
        function clearAuthForms() {
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Show auth message
        function showAuthMessage(message, isError = false) {
            const errorDiv = document.getElementById('authError');
            const successDiv = document.getElementById('authSuccess');
            
            if (isError) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
            } else {
                successDiv.textContent = message;
                successDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
            }
        }

        // Load accounts from Google Sheets
        async function loadAccounts() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${accountsSpreadsheetId}/export?format=csv&gid=${accountsGid}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch accounts data');
                
                const csvData = await response.text();
                const accounts = parseAccountsCSV(csvData);
                return accounts;
            } catch (error) {
                console.error('Error loading accounts:', error);
                // Fallback to localStorage for demo purposes
                return JSON.parse(localStorage.getItem('osuBountyAccounts') || '[]');
            }
        }

        // Parse accounts CSV data
        function parseAccountsCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const accounts = [];
            
            // Skip header row if it exists
            const startIndex = lines[0].toLowerCase().includes('username') ? 1 : 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 2) {
                    accounts.push({
                        username: values[0] || '',
                        password: values[1] || ''
                    });
                }
            }
            
            return accounts;
        }

        // Save account to Google Sheets (note: requires backend for write operations)
        async function saveAccount(username, hashedPassword) {
            // Note: Google Sheets API requires authentication for write operations
            // For now, we'll store in localStorage and show a message
            const accounts = JSON.parse(localStorage.getItem('osuBountyAccounts') || '[]');
            
            if (accounts.find(acc => acc.username === username)) {
                throw new Error('Username already exists');
            }
            
            accounts.push({ username, password: hashedPassword });
            localStorage.setItem('osuBountyAccounts', JSON.stringify(accounts));
            
            // In production, this would be a server-side operation to update the Google Sheet
            console.log('Note: Account saved locally. For production, implement server-side Google Sheets API integration.');
            
            return true;
        }

        // Find account by username (now uses Google Sheets data)
        async function findAccount(username) {
            try {
                const accounts = await loadAccounts();
                return accounts.find(acc => acc.username === username);
            } catch (error) {
                console.error('Error finding account:', error);
                // Fallback to localStorage
                const accounts = JSON.parse(localStorage.getItem('osuBountyAccounts') || '[]');
                return accounts.find(acc => acc.username === username);
            }
        }

        // Login function
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showAuthMessage('Please enter username and password', true);
                return;
            }
            
            const hashedPassword = sha256(password);
            
            try {
                showAuthMessage('Checking credentials...', false);
                const account = await findAccount(username);
                
                if (account && account.password === hashedPassword) {
                    currentUser = { username };
                    localStorage.setItem('osuBountyUser', JSON.stringify(currentUser));
                    showUserInfo();
                    hideAuthModal();
                    showAuthMessage('Login successful!');
                } else {
                    showAuthMessage('Invalid username or password', true);
                }
            } catch (error) {
                console.error('Login error:', error);
                showAuthMessage('Login failed. Please try again.', true);
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            localStorage.removeItem('osuBountyUser');
            hideUserInfo();
        }

        // Show user info
        function showUserInfo() {
            document.getElementById('username').textContent = currentUser.username;
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('loginPrompt').classList.add('hidden');
        }

        // Hide user info
        function hideUserInfo() {
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('loginPrompt').classList.remove('hidden');
        }

        // Update bounty acceptance to open Google Form
        function acceptBounty(bountyTitle, bountyMap, beatmapId) {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            
            // Google Form URL from plan
            const googleFormUrl = 'https://forms.gle/FRKXVaR6EhThqa186';
            
            // Pre-fill form with bounty information
            // Note: You'll need to get the actual entry IDs from your form
            const preFilledUrl = `${googleFormUrl}?usp=pp_url&entry.1234567890=${encodeURIComponent(bountyTitle)}&entry.0987654321=${encodeURIComponent(bountyMap)}&entry.1122334456=${encodeURIComponent(beatmapId)}&entry.5566778899=${encodeURIComponent(currentUser.username)}`;
            
            // Open form in a new tab
            window.open(preFilledUrl, '_blank');
        }
    </script>
</body>
</html>